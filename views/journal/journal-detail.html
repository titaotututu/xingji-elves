<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行迹精灵 - 日志详情</title>
    <!-- 引入外部样式库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/xingji-elves/images/logo1.svg" type="image/svg+xml">
    <link rel="stylesheet" href="../style-views.css">
    <style>
        /* 页面整体布局 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #87CEEB, #ffffff);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .log-detail-container {
            margin-top:100px; /* 增加顶部间距，避免返回按钮和标题重叠 */
            width: 90%; /* 增加宽度 */
            max-width: 700px; /* 增加最大宽度 */
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        /* 返回按钮样式 */
        .back-button {
            position: absolute;
            top: 20px; /* 调整返回按钮的顶部位置 */
            left: 20px; /* 调整返回按钮的左侧位置 */
            width: 40px; /* 按钮宽度 */
            height: 40px; /* 按钮高度 */
            background-color: transparent; /* 移除背景色 */
            border: none; /* 移除边框 */
            border-radius: 50%; /* 可选：如果需要圆形按钮 */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            padding: 0; /* 移除内边距 */
        }

        .back-button:hover {
            background-color: #f0f0f0; /* 可选：悬停时的背景色 */
        }

        .back-icon {
            width: 40px; /* 图标宽度 */
            height: 40px; /* 图标高度 */
            object-fit: contain; /* 确保图标按比例缩放 */
        }

        /* 旅行名称 */
        .travel-title {
            font-size: 1.75rem;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        /* 天气和心情 */
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .log-header-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        select.log-input {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            outline: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        select.log-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }

        /* 日志标题和描述 */
        input.log-input, textarea.log-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            margin-top: 20px; /* 增加日志标题的顶部间距 */
        }
        input.log-input:focus, textarea.log-textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        textarea.log-textarea {
            min-height: 120px;
        }

        /* 图片上传和预览 */
        .log-image-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .log-image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }
        .log-image-preview img:hover {
            transform: scale(1.05);
        }

        /* 保存按钮 */
        .save-log-button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .save-log-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <script src="../../components/auth.js"></script>
    <nav>
        <a href="../main.html">首页</a>
        <a href="../travel.html">行程</a>
        <a href="../map.html">导航</a>
        <a href="../Weather.html">天气</a>
        <a href="../lighting.html">点亮地标</a>
        <a href="../journal.html">旅行日志</a>
        <a href="../community.html">社区</a>
        <div class="dropdown">
            <button class="dropbtn">更多</button>
            <div class="dropdown-content">
                <a href="../profile.html">个人信息</a>
                <a href="../feedback.html">反馈</a>
            </div>
        </div>
        <a href="#" id="logout-btn">退出</a>
    </nav>
    <div class="log-detail-container">
        <!-- 返回按钮 -->
        <button class="back-button" onclick="window.location.href='../journal.html'">
            <img src="../../images/return.svg" alt="返回" class="back-icon" />
        </button>

        <!-- 日志标题 -->
        <input type="text" id="logTitle" class="log-input" placeholder="日志标题" />

        <!-- 日志头部（天气和心情） -->
        <div class="log-header">
            <div class="log-header-item">
                <label for="weather">天气：</label>
                <select id="weather" class="log-input">
                    <option value="">选择天气</option>
                    <option value="sunny">晴天</option>
                    <option value="cloudy">多云</option>
                    <option value="rainy">下雨</option>
                    <option value="snowy">下雪</option>
                </select>
            </div>
            <div class="log-header-item">
                <label for="mood">心情：</label>
                <select id="mood" class="log-input">
                    <option value="">选择心情</option>
                    <option value="happy">开心</option>
                    <option value="sad">悲伤</option>
                    <option value="excited">兴奋</option>
                    <option value="tired">疲惫</option>
                </select>
            </div>
        </div>

        <!-- 日志描述 -->
        <textarea id="description" class="log-textarea" placeholder="写下你的旅行故事..."></textarea>

        <!-- 是否公开 -->
        <div>
            <label for="isPublic">是否公开：</label>
            <input type="checkbox" id="isPublic" />
        </div>

        <!-- 图片上传 -->
        <div>
            <label for="imageUpload" class="btn btn-secondary">添加图片</label>
            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" />
        </div>
        <div class="log-image-preview" id="imagePreview"></div>

        <!-- 保存按钮 -->
        <button type="submit" class="save-log-button">保存日志</button>
    </div>

    <script>
        // 初始化页面
        window.onload = async function () {
            const logId = new URLSearchParams(window.location.search).get("id");
            if (logId) {
                try {
                    const response = await fetch(`http://localhost:5199/api/Journal/get?journalid=${logId}`);
                    if (!response.ok) throw new Error(await response.text());
                    const log = await response.json();
                    // 填充表单
                    document.getElementById("logTitle").value = log.title || "";
                    document.getElementById("weather").value = log.weather || "";
                    document.getElementById("mood").value = log.emotion || "";
                    document.getElementById("description").value = log.description || "";
                    document.getElementById("isPublic").checked = log.isPublic || false;
                    // 图片显示
                    if (log.picture) {
                        const imagePreview = document.getElementById("imagePreview");
                        log.picture.split(" ").forEach(fileName => {
                            if (fileName.trim()) {
                                const img = document.createElement("img");
                                img.src = `http://localhost:5199/api/File/download?fileName=${fileName}`;
                                imagePreview.appendChild(img);
                            }
                        });
                    }
                } catch (e) {
                    alert("加载日志失败：" + e.message);
                }
            }
        };

        // 图片上传
        document.getElementById("imageUpload").addEventListener("change", function (e) {
            const files = e.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const imgElement = `<img src="${event.target.result}" alt="日志图片" />`;
                    document.getElementById("imagePreview").innerHTML += imgElement;
                };
                reader.readAsDataURL(file);
            });
        });

        // 保存日志
        document.querySelector(".save-log-button").addEventListener("click", async function () {
            const userId = sessionStorage.getItem('userId');
            const isPublic = document.getElementById("isPublic").checked;

            const logData = {
                Time: new Date().toISOString(),
                Title: document.getElementById("logTitle").value,
                Weather: document.getElementById("weather").value,
                Emotion: document.getElementById("mood").value,
                Description: document.getElementById("description").value,
                Picture: "", // 先不传图片，图片单独上传
                UserId: Number(userId),
                IsPublic: isPublic
            };

            try {
                // 新建日志（本地数据库）
                const response = await fetch('http://localhost:5199/api/Journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                if (!response.ok) throw new Error(await response.text());
                const journal = await response.json();


                // 上传图片
                const files = document.getElementById("imageUpload").files;
                if (files.length > 0) {
                    const formData = new FormData();
                    for (let file of files) {
                        formData.append('file', file);
                    }
                    await fetch(`http://localhost:5199/api/File/upload?journalId=${journal.journalId}`, {
                        method: 'POST',
                        body: formData
                    });
                }

                // 如果选择公开，调用 Python 服务器 API
                const PythonlogData = {
                    JournalId: String(journal.journalId), // 加入 JournalId
                    Time: new Date().toISOString(),
                    Title: document.getElementById("logTitle").value,
                    Weather: document.getElementById("weather").value,
                    Emotion: document.getElementById("mood").value,
                    Description: document.getElementById("description").value,
                    Picture: "", // 先不传图片，图片单独上传
                    UserId: Number(userId)
                };
                PythonlogData.Time = PythonlogData.Time.replace('Z', '');


                const jsonData = JSON.stringify(PythonlogData);
                console.log("Serialized JSON:", jsonData);
                console.log("PythonlogData:", PythonlogData);
                if (isPublic) {
                    const pythonResponse = await fetch('http://localhost:5199/api/python/journal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: jsonData
                    });
                    if (!pythonResponse.ok) throw new Error(await pythonResponse.text());

                    // 上传图片到 Python 服务器
                    if (files.length > 0) {
                        for (let file of files) {
                            const pythonFormData = new FormData();
                            pythonFormData.append('image', file);

                            const uploadResponse = await fetch(`http://localhost:5199/api/python/journal/${userId}${journal.journalId}/image`, {
                                method: 'POST',
                                body: pythonFormData
                            });

                            if (!uploadResponse.ok) {
                                console.error(`图片上传失败: ${file.name}`);
                                throw new Error(await uploadResponse.text());
                            }
                        }
                    }
                }

                alert("日志已保存！");
                window.location.href = "../journal.html";
            } catch (error) {
                alert("保存失败：" + error.message);
            }
        });
    </script>
</body>
</html>
``` 